name: Desktop Bridge - Release

on:
  workflow_run:
    workflows:
      - "Desktop Bridge - macOS"
      - "Desktop Bridge - Windows"
      - "Desktop Bridge - Linux"
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=v$(date +%Y.%m.%d)-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -R artifacts/

      - name: Create checksums
        run: |
          cd artifacts
          for artifact in */waddlebot-bridge-*; do
            if [ -f "$artifact" ]; then
              sha256sum "$artifact" >> checksums.txt
            fi
          done
          cat checksums.txt

      - name: Create release notes
        run: |
          cat > release-notes.md << 'EOF'
          # WaddleBot Premium Desktop Bridge Release

          ## Features
          - **OBS Integration**: Full OBS Studio control via WebSocket
          - **Local API Gateway**: REST + WebSocket endpoints for local apps
          - **Scripting Engine**: Lua, Python3, PowerShell, and Bash support
          - **Cross-Platform**: macOS (AMD64 + ARM64), Windows (AMD64), Linux (AMD64 + ARM64)

          ## Installation

          ### macOS
          ```bash
          # AMD64 (Intel)
          chmod +x waddlebot-bridge-darwin-amd64
          ./waddlebot-bridge-darwin-amd64

          # ARM64 (Apple Silicon)
          chmod +x waddlebot-bridge-darwin-arm64
          ./waddlebot-bridge-darwin-arm64
          ```

          ### Windows
          ```powershell
          # Double-click or run in PowerShell
          .\waddlebot-bridge-windows-amd64.exe
          ```

          ### Linux (Debian/Ubuntu)
          ```bash
          # Install .deb package (AMD64)
          sudo dpkg -i waddlebot-bridge_1.0.0_amd64.deb

          # Install .deb package (ARM64)
          sudo dpkg -i waddlebot-bridge_1.0.0_arm64.deb

          # Or run binary directly
          chmod +x waddlebot-bridge-linux-amd64
          ./waddlebot-bridge-linux-amd64
          ```

          ## Configuration
          Create `~/.waddlebot-bridge.yaml`:
          ```yaml
          community-id: "your-community-id"
          user-id: "your-user-id"
          api-url: "https://api.waddlebot.io"

          obs:
            enabled: true
            host: localhost
            port: 4455
            password: "your-obs-password"

          gateway:
            enabled: true
            host: 127.0.0.1
            port: 8090

          scripting:
            enabled: true
            enable-lua: true
            enable-python: true
          ```

          ## Checksums
          See `checksums.txt` for SHA256 verification.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Desktop Bridge ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/waddlebot-bridge-darwin-amd64/waddlebot-bridge-darwin-amd64
            artifacts/waddlebot-bridge-darwin-arm64/waddlebot-bridge-darwin-arm64
            artifacts/waddlebot-bridge-windows-amd64/waddlebot-bridge-windows-amd64.exe
            artifacts/waddlebot-bridge-linux-amd64/waddlebot-bridge-linux-amd64
            artifacts/waddlebot-bridge-linux-arm64/waddlebot-bridge-linux-arm64
            artifacts/waddlebot-bridge-deb/waddlebot-bridge_1.0.0_amd64.deb
            artifacts/waddlebot-bridge-deb/waddlebot-bridge_1.0.0_arm64.deb
            artifacts/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
