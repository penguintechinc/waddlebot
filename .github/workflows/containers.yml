name: Container Builds

on:
  push:
    branches: [ main, develop, 'feature/**', 'bugfix/**' ]
    paths:
      - 'processing/router_module/**'
      - 'trigger/receiver/**'
      - 'action/interactive/**'
      - 'action/pushing/**'
      - 'action/security/**'
      - 'core/**'
      - 'admin/hub_module/**'
      - 'libs/flask_core/**'
      - 'docker-compose.yml'
      - '.version'
      - '.github/workflows/containers.yml'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Determine version and tag suffix
  determine-version:
    name: Determine Version and Tags
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      suffix: ${{ steps.version.outputs.suffix }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determine version and suffix
        id: version
        run: |
          # Read version from .version file
          if [ -f .version ]; then
            VERSION=$(cat .version | tr -d '[:space:]')
          else
            VERSION="0.0.0"
          fi

          echo "version=v${VERSION}" >> $GITHUB_OUTPUT

          # Check if .version file changed (indicates a release)
          if git diff HEAD^ HEAD --name-only | grep -q "^.version$"; then
            IS_RELEASE="true"
          else
            IS_RELEASE="false"
          fi

          # Determine suffix based on branch and release status
          if [ "$IS_RELEASE" = "true" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # Version release on main: no suffix, plus 'latest' tag
            SUFFIX=""
            echo "suffix=" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "Building RELEASE: v${VERSION} and latest"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # Main branch, not a release: -beta suffix
            SUFFIX="-beta"
            echo "suffix=-beta" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "Building BETA: v${VERSION}-beta"
          else
            # Non-main branch: -alpha suffix
            SUFFIX="-alpha"
            echo "suffix=-alpha" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "Building ALPHA: v${VERSION}-alpha"
          fi

  # Detect changed modules
  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      router: ${{ steps.changes.outputs.router }}
      marketplace: ${{ steps.changes.outputs.marketplace }}
      portal: ${{ steps.changes.outputs.portal }}
      kong-admin: ${{ steps.changes.outputs.kong-admin }}
      twitch: ${{ steps.changes.outputs.twitch }}
      discord: ${{ steps.changes.outputs.discord }}
      slack: ${{ steps.changes.outputs.slack }}
      ai-interaction: ${{ steps.changes.outputs.ai-interaction }}
      inventory-interaction: ${{ steps.changes.outputs.inventory-interaction }}
      labels-core: ${{ steps.changes.outputs.labels-core }}
      alias-interaction: ${{ steps.changes.outputs.alias-interaction }}
      shoutout-interaction: ${{ steps.changes.outputs.shoutout-interaction }}
      libs: ${{ steps.changes.outputs.libs }}
      kong: ${{ steps.changes.outputs.kong }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            router:
              - 'router_module/**'
              - 'libs/**'
            marketplace:
              - 'marketplace_module/**'
              - 'libs/**'
            portal:
              - 'portal_module/**'
              - 'libs/**'
            kong-admin:
              - 'kong_admin_broker/**'
              - 'libs/**'
            twitch:
              - 'twitch_module/**'
              - 'libs/**'
            discord:
              - 'discord_module/**'
              - 'libs/**'
            slack:
              - 'slack_module/**'
              - 'libs/**'
            ai-interaction:
              - 'ai_interaction_module/**'
              - 'libs/**'
            inventory-interaction:
              - 'inventory_interaction_module/**'
              - 'libs/**'
            labels-core:
              - 'labels_core_module/**'
              - 'libs/**'
            alias-interaction:
              - 'alias_interaction_module/**'
              - 'libs/**'
            shoutout-interaction:
              - 'shoutout_interaction_module/**'
              - 'libs/**'
            libs:
              - 'libs/**'
            kong:
              - 'kong/**'

  # Build core modules
  build-core:
    name: Build Core Modules
    runs-on: ubuntu-latest
    needs: [determine-version, detect-changes]
    if: needs.detect-changes.outputs.router == 'true' || needs.detect-changes.outputs.marketplace == 'true' || needs.detect-changes.outputs.portal == 'true' || needs.detect-changes.outputs.kong-admin == 'true' || needs.detect-changes.outputs.libs == 'true' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        include:
          - module: router_module
            name: router
            port: 8000
            condition: ${{ needs.detect-changes.outputs.router == 'true' || needs.detect-changes.outputs.libs == 'true' }}
          - module: marketplace_module
            name: marketplace
            port: 8001
            condition: ${{ needs.detect-changes.outputs.marketplace == 'true' || needs.detect-changes.outputs.libs == 'true' }}
          - module: portal_module
            name: portal
            port: 8002
            condition: ${{ needs.detect-changes.outputs.portal == 'true' || needs.detect-changes.outputs.libs == 'true' }}
          - module: kong_admin_broker
            name: kong-admin-broker
            port: 8003
            condition: ${{ needs.detect-changes.outputs.kong-admin == 'true' || needs.detect-changes.outputs.libs == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.name }}
          tags: |
            type=raw,value=${{ needs.determine-version.outputs.version }}${{ needs.determine-version.outputs.suffix }}
            type=raw,value=latest,enable=${{ needs.determine-version.outputs.is_release == 'true' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        if: matrix.condition == 'true' || github.event_name == 'workflow_dispatch'
        with:
          context: .
          file: ./${{ matrix.module }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.name }}
          build-args: |
            MODULE_NAME=${{ matrix.name }}
            MODULE_PORT=${{ matrix.port }}

      - name: Run container tests
        if: matrix.condition == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          # Test the built image
          docker run --rm --name test-${{ matrix.name }} -d -p ${{ matrix.port }}:${{ matrix.port }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.name }}:latest
          sleep 10
          
          # Health check
          if curl -f http://localhost:${{ matrix.port }}/health; then
            echo "✅ Health check passed for ${{ matrix.name }}"
          else
            echo "❌ Health check failed for ${{ matrix.name }}"
            exit 1
          fi
          
          # Stop container
          docker stop test-${{ matrix.name }}

  # Build collector modules
  build-collectors:
    name: Build Collector Modules
    runs-on: ubuntu-latest
    needs: [determine-version, detect-changes]
    if: needs.detect-changes.outputs.twitch == 'true' || needs.detect-changes.outputs.discord == 'true' || needs.detect-changes.outputs.slack == 'true' || needs.detect-changes.outputs.libs == 'true' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        include:
          - module: twitch_module
            name: twitch-collector
            port: 8010
            condition: ${{ needs.detect-changes.outputs.twitch == 'true' || needs.detect-changes.outputs.libs == 'true' }}
          - module: discord_module
            name: discord-collector
            port: 8011
            condition: ${{ needs.detect-changes.outputs.discord == 'true' || needs.detect-changes.outputs.libs == 'true' }}
          - module: slack_module
            name: slack-collector
            port: 8012
            condition: ${{ needs.detect-changes.outputs.slack == 'true' || needs.detect-changes.outputs.libs == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.name }}
          tags: |
            type=raw,value=${{ needs.determine-version.outputs.version }}${{ needs.determine-version.outputs.suffix }}
            type=raw,value=latest,enable=${{ needs.determine-version.outputs.is_release == 'true' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        if: matrix.condition == 'true' || github.event_name == 'workflow_dispatch'
        with:
          context: .
          file: ./${{ matrix.module }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.name }}
          build-args: |
            MODULE_NAME=${{ matrix.name }}
            MODULE_PORT=${{ matrix.port }}

      - name: Run container tests
        if: matrix.condition == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          # Test the built image
          docker run --rm --name test-${{ matrix.name }} -d -p ${{ matrix.port }}:${{ matrix.port }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.name }}:latest
          sleep 10
          
          # Health check
          if curl -f http://localhost:${{ matrix.port }}/health; then
            echo "✅ Health check passed for ${{ matrix.name }}"
          else
            echo "❌ Health check failed for ${{ matrix.name }}"
            exit 1
          fi
          
          # Stop container
          docker stop test-${{ matrix.name }}

  # Build interaction modules
  build-interactions:
    name: Build Interaction Modules
    runs-on: ubuntu-latest
    needs: [determine-version, detect-changes]
    if: needs.detect-changes.outputs.ai-interaction == 'true' || needs.detect-changes.outputs.inventory-interaction == 'true' || needs.detect-changes.outputs.labels-core == 'true' || needs.detect-changes.outputs.alias-interaction == 'true' || needs.detect-changes.outputs.shoutout-interaction == 'true' || needs.detect-changes.outputs.libs == 'true' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        include:
          - module: ai_interaction_module
            name: ai-interaction
            port: 8020
            condition: ${{ needs.detect-changes.outputs.ai-interaction == 'true' || needs.detect-changes.outputs.libs == 'true' }}
          - module: inventory_interaction_module
            name: inventory-interaction
            port: 8024
            condition: ${{ needs.detect-changes.outputs.inventory-interaction == 'true' || needs.detect-changes.outputs.libs == 'true' }}
          - module: labels_core_module
            name: labels-core
            port: 8021
            condition: ${{ needs.detect-changes.outputs.labels-core == 'true' || needs.detect-changes.outputs.libs == 'true' }}
          - module: alias_interaction_module
            name: alias-interaction
            port: 8022
            condition: ${{ needs.detect-changes.outputs.alias-interaction == 'true' || needs.detect-changes.outputs.libs == 'true' }}
          - module: shoutout_interaction_module
            name: shoutout-interaction
            port: 8023
            condition: ${{ needs.detect-changes.outputs.shoutout-interaction == 'true' || needs.detect-changes.outputs.libs == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.name }}
          tags: |
            type=raw,value=${{ needs.determine-version.outputs.version }}${{ needs.determine-version.outputs.suffix }}
            type=raw,value=latest,enable=${{ needs.determine-version.outputs.is_release == 'true' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        if: matrix.condition == 'true' || github.event_name == 'workflow_dispatch'
        with:
          context: .
          file: ./${{ matrix.module }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.name }}
          build-args: |
            MODULE_NAME=${{ matrix.name }}
            MODULE_PORT=${{ matrix.port }}

      - name: Run container tests
        if: matrix.condition == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          # Test the built image
          docker run --rm --name test-${{ matrix.name }} -d -p ${{ matrix.port }}:${{ matrix.port }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.name }}:latest
          sleep 10
          
          # Health check
          if curl -f http://localhost:${{ matrix.port }}/health; then
            echo "✅ Health check passed for ${{ matrix.name }}"
          else
            echo "❌ Health check failed for ${{ matrix.name }}"
            exit 1
          fi
          
          # Stop container
          docker stop test-${{ matrix.name }}

  # Build Kong infrastructure
  build-kong:
    name: Build Kong Infrastructure
    runs-on: ubuntu-latest
    needs: [determine-version, detect-changes]
    if: needs.detect-changes.outputs.kong == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/kong
          tags: |
            type=raw,value=${{ needs.determine-version.outputs.version }}${{ needs.determine-version.outputs.suffix }}
            type=raw,value=latest,enable=${{ needs.determine-version.outputs.is_release == 'true' }}

      - name: Build and push Kong image
        uses: docker/build-push-action@v5
        with:
          context: ./kong
          file: ./kong/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha,scope=kong
          cache-to: type=gha,mode=max,scope=kong

  # Integration tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-core, build-collectors, build-interactions]
    if: always() && (needs.build-core.result == 'success' || needs.build-collectors.result == 'success' || needs.build-interactions.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Start services
        run: |
          # Use the latest built images
          export REGISTRY=${{ env.REGISTRY }}
          export IMAGE_NAME=${{ env.IMAGE_NAME }}
          export TAG=latest
          
          # Start core services
          docker-compose -f docker-compose.yml up -d postgres redis kong
          
          # Wait for services to be ready
          sleep 30
          
          # Start application services
          docker-compose -f docker-compose.yml up -d

      - name: Run integration tests
        run: |
          # Wait for all services to be ready
          sleep 60
          
          # Test router health
          curl -f http://localhost:8000/health || exit 1
          
          # Test marketplace health
          curl -f http://localhost:8001/health || exit 1
          
          # Test portal health
          curl -f http://localhost:8002/health || exit 1
          
          # Test Kong gateway
          curl -f http://localhost:8080/health || exit 1
          
          echo "✅ All integration tests passed"

      - name: Cleanup
        if: always()
        run: docker-compose -f docker-compose.yml down -v

  # Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build-core, build-collectors, build-interactions]
    if: always() && (needs.build-core.result == 'success' || needs.build-collectors.result == 'success' || needs.build-interactions.result == 'success')
    strategy:
      matrix:
        image:
          - router
          - marketplace
          - portal
          - kong-admin-broker
          - twitch-collector
          - discord-collector
          - slack-collector
          - ai-interaction
          - inventory-interaction
          - labels-core
          - alias-interaction
          - shoutout-interaction
    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.image }}:latest
          format: 'sarif'
          output: 'trivy-${{ matrix.image }}.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.image }}.sarif'

  # Create GitHub Release
  create-release:
    name: Create Pre-Release
    runs-on: ubuntu-latest
    needs: [determine-version, build-core, build-collectors, build-interactions]
    if: needs.determine-version.outputs.is_release == 'true' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create pre-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"

          # Check if release already exists
          if gh release view "$VERSION" > /dev/null 2>&1; then
            echo "⏭️ Release $VERSION already exists, skipping"
            exit 0
          fi

          # Create release notes
          cat << EOF > release_notes.md
          ## Pre-Release $VERSION

          This is an automated pre-release created when the .version file was updated.

          **Container Images Built:**
          - All modules tagged with \`$VERSION\` and \`latest\`
          - Available at \`ghcr.io/${{ github.repository }}\`

          ### Changes

          See commit history for detailed changes since last release.

          ---
          *This pre-release was automatically generated by the CI/CD pipeline.*
          EOF

          gh release create "$VERSION" \
            --title "$VERSION" \
            --notes-file release_notes.md \
            --prerelease \
            --target ${{ github.sha }}

          echo "✅ Created pre-release $VERSION"

  # Notify on completion
  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [determine-version, build-core, build-collectors, build-interactions, integration-tests, security-scan]
    if: always()
    steps:
      - name: Build Status Summary
        run: |
          echo "## Container Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Core Modules | ${{ needs.build-core.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Collector Modules | ${{ needs.build-collectors.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Interaction Modules | ${{ needs.build-interactions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY