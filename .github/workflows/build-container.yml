name: Build Container (Reusable)

on:
  workflow_call:
    inputs:
      module_path:
        required: true
        type: string
        description: 'Path to module directory (e.g., processing/router_module)'
      module_name:
        required: true
        type: string
        description: 'Container name (e.g., router)'
      module_port:
        required: true
        type: string
        description: 'Module port (e.g., 8000)'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  determine-version:
    name: Determine Version and Tags
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      suffix: ${{ steps.version.outputs.suffix }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determine version and suffix
        id: version
        run: |
          # Read version from .version file
          if [ -f .version ]; then
            VERSION=$(cat .version | tr -d '[:space:]')
          else
            VERSION="0.0.0"
          fi

          echo "version=v${VERSION}" >> $GITHUB_OUTPUT

          # Check if .version file changed (indicates a release)
          if git diff HEAD^ HEAD --name-only | grep -q "^.version$"; then
            IS_RELEASE="true"
          else
            IS_RELEASE="false"
          fi

          # Determine suffix based on branch and release status
          if [ "$IS_RELEASE" = "true" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # Version release on main: no suffix, plus 'latest' tag
            echo "suffix=" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "Building RELEASE: v${VERSION} and latest"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # Main branch, not a release: -beta suffix
            echo "suffix=-beta" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "Building BETA: v${VERSION}-beta"
          else
            # Non-main branch: -alpha suffix
            echo "suffix=-alpha" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "Building ALPHA: v${VERSION}-alpha"
          fi

  build-and-push:
    name: Build and Push Container
    runs-on: ubuntu-latest
    needs: determine-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ inputs.module_name }}
          tags: |
            type=raw,value=${{ needs.determine-version.outputs.version }}${{ needs.determine-version.outputs.suffix }}
            type=raw,value=latest,enable=${{ needs.determine-version.outputs.is_release == 'true' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ inputs.module_path }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha,scope=${{ inputs.module_name }}
          cache-to: type=gha,mode=max,scope=${{ inputs.module_name }}
          build-args: |
            MODULE_NAME=${{ inputs.module_name }}
            MODULE_PORT=${{ inputs.module_port }}

      - name: Build summary
        run: |
          echo "## Build Complete: ${{ inputs.module_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ inputs.module_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.determine-version.outputs.version }}${{ needs.determine-version.outputs.suffix }}\`" >> $GITHUB_STEP_SUMMARY
