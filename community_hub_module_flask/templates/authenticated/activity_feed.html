{% extends "layout.html" %}

{% block title %}Activity - {{ community.name }} - WaddleBot{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <nav class="breadcrumb" aria-label="breadcrumbs">
            <ul>
                <li><a href="{{ url_for('authenticated.dashboard') }}">Dashboard</a></li>
                <li><a href="{{ url_for('authenticated.community_hub', community_id=community.id) }}">{{ community.name }}</a></li>
                <li class="is-active"><a href="#">Activity</a></li>
            </ul>
        </nav>

        <h1 class="title">Activity Feed</h1>
        <p class="subtitle">Cross-platform activity for {{ community.name }}</p>

        <!-- Activity Summary -->
        <div class="columns mb-5">
            <div class="column">
                <div class="box has-text-centered">
                    <p class="heading">Events (24h)</p>
                    <p class="title">{{ summary.total_events }}</p>
                </div>
            </div>
            <div class="column">
                <div class="box has-text-centered">
                    <p class="heading">Active Users</p>
                    <p class="title">{{ summary.unique_users }}</p>
                </div>
            </div>
            <div class="column">
                <div class="box has-text-centered">
                    <p class="heading">Points Earned</p>
                    <p class="title">{{ summary.total_points | format_number }}</p>
                </div>
            </div>
        </div>

        <!-- Platform Filter -->
        <div class="buttons mb-4">
            <button class="button is-small platform-filter is-active" data-platform="all">All</button>
            {% if summary.by_platform.discord %}
            <button class="button is-small platform-filter discord-bg" data-platform="discord">
                <i class="fab fa-discord mr-1"></i> Discord ({{ summary.by_platform.discord }})
            </button>
            {% endif %}
            {% if summary.by_platform.twitch %}
            <button class="button is-small platform-filter twitch-bg" data-platform="twitch">
                <i class="fab fa-twitch mr-1"></i> Twitch ({{ summary.by_platform.twitch }})
            </button>
            {% endif %}
            {% if summary.by_platform.slack %}
            <button class="button is-small platform-filter slack-bg" data-platform="slack">
                <i class="fab fa-slack mr-1"></i> Slack ({{ summary.by_platform.slack }})
            </button>
            {% endif %}
        </div>

        <!-- Activity List -->
        <div id="activity-feed" class="box">
            {% if activities %}
            {% for activity in activities %}
            <div class="activity-item level is-mobile" data-platform="{{ activity.platform }}">
                <div class="level-left">
                    <div>
                        <span class="platform-badge {{ activity.platform }}-bg mr-2">
                            <i class="fab fa-{{ activity.platform }}"></i>
                        </span>
                        <strong>{{ activity.user_name }}</strong>
                        <span class="has-text-grey">{{ activity.event_label }}</span>
                        {% if activity.details.amount %}
                        <span class="tag is-info is-small">{{ activity.details.amount }}</span>
                        {% endif %}
                        <br>
                        <span class="is-size-7 has-text-grey">
                            {{ activity.relative_time }}
                        </span>
                    </div>
                </div>
                <div class="level-right">
                    <span class="tag {% if activity.points > 0 %}is-success{% else %}is-danger{% endif %}">
                        {% if activity.points > 0 %}+{% endif %}{{ activity.points }} pts
                    </span>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="has-text-grey has-text-centered">No activity recorded yet.</p>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/activity-feed.js') }}"></script>
<script>
    // Platform filter
    document.querySelectorAll('.platform-filter').forEach(btn => {
        btn.addEventListener('click', function() {
            const platform = this.dataset.platform;

            document.querySelectorAll('.platform-filter').forEach(b => b.classList.remove('is-active'));
            this.classList.add('is-active');

            document.querySelectorAll('.activity-item').forEach(item => {
                if (platform === 'all' || item.dataset.platform === platform) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });

    // Live polling
    initActivityFeed({{ community.id }}, {{ polling_interval * 1000 }});
</script>
{% endblock %}
