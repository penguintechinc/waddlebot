# WaddleBot Docker Compose - Unified Configuration
# Secure network isolation: internal services not exposed to host

networks:
  # Public network - services exposed to host
  waddlebot-public:
    driver: bridge

  # Internal network - database, redis, inter-service communication
  waddlebot-internal:
    driver: bridge
    internal: true

volumes:
  postgres-data:
  redis-data:
  minio-data:

services:
  # =============================================================================
  # INFRASTRUCTURE SERVICES (Internal Only - NOT exposed to host)
  # =============================================================================

  postgres:
    image: postgres:15-alpine
    container_name: waddlebot-postgres
    environment:
      POSTGRES_USER: waddlebot
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-waddlebot_secret}
      POSTGRES_DB: waddlebot
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - waddlebot-internal
    # NO ports exposed - internal only
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U waddlebot"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: waddlebot-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-waddlebot_redis} --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - waddlebot-internal
    # NO ports exposed - internal only
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-waddlebot_redis}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    container_name: waddlebot-minio
    ports:
      - "9000:9000"   # MinIO API
      - "9001:9001"   # MinIO Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-waddlebot}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-waddlebot123}
      MINIO_DOMAIN: localhost
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - waddlebot-internal
      - waddlebot-public
    restart: unless-stopped

  # Apache OpenWhisk standalone for testing serverless actions
  openwhisk:
    image: openwhisk/standalone:nightly
    container_name: waddlebot-openwhisk
    ports:
      - "3233:3233"   # OpenWhisk API
    environment:
      JAVA_OPTS: "-Xmx1g"
    networks:
      - waddlebot-internal
      - waddlebot-public
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3233/api/v1"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 5
    restart: unless-stopped

  # =============================================================================
  # CORE MODULES
  # =============================================================================

  router:
    build:
      context: .
      dockerfile: processing/router_module/Dockerfile
    container_name: waddlebot-router
    environment:
      MODULE_NAME: router
      MODULE_PORT: 8000
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-waddlebot_redis}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # marketplace service removed - functionality now in hub admin panel

  hub:
    build:
      context: ./admin/hub_module
      dockerfile: Dockerfile
    container_name: waddlebot-hub
    environment:
      NODE_ENV: production
      PORT: 8060
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-waddlebot_redis}
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
      BASE_DOMAIN: ${BASE_DOMAIN:-waddlebot.io}
      # OAuth Configuration
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET}
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
      SLACK_CLIENT_ID: ${SLACK_CLIENT_ID}
      SLACK_CLIENT_SECRET: ${SLACK_CLIENT_SECRET}
      # Internal service URLs
      ROUTER_API_URL: http://router:8000
      IDENTITY_API_URL: http://identity-core:8050
      INVENTORY_API_URL: http://inventory-interaction:8024
      REPUTATION_API_URL: http://reputation:8021
      CALENDAR_API_URL: http://calendar-interaction:8030
      MEMORIES_API_URL: http://memories-interaction:8031
      LABELS_API_URL: http://labels-core:8023
      SHOUTOUT_API_URL: http://shoutout-interaction:8011
      BROWSER_SOURCE_API_URL: http://browser-source:8027
      # S3 Storage Configuration (MinIO)
      S3_STORAGE_ENABLED: "true"
      S3_BUCKET_NAME: waddlebot-assets
      S3_ENDPOINT_URL: http://minio:9000
      S3_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-waddlebot}
      S3_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-waddlebot123}
      S3_PUBLIC_BASE_URL: http://localhost:9000/waddlebot-assets
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8060:8060"  # Community Hub WebUI (public)
    networks:
      - waddlebot-public
      - waddlebot-internal
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8060/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # COLLECTOR MODULES (Internal)
  # =============================================================================

  twitch-collector:
    build:
      context: .
      dockerfile: trigger/receiver/twitch_module/Dockerfile
    container_name: waddlebot-twitch
    environment:
      MODULE_NAME: twitch-collector
      MODULE_PORT: 8002
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
      TWITCH_WEBHOOK_SECRET: ${TWITCH_WEBHOOK_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  discord-collector:
    build:
      context: .
      dockerfile: trigger/receiver/discord_module/Dockerfile
    container_name: waddlebot-discord
    environment:
      MODULE_NAME: discord-collector
      MODULE_PORT: 8003
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}
      DISCORD_APPLICATION_ID: ${DISCORD_APPLICATION_ID}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  slack-collector:
    build:
      context: .
      dockerfile: trigger/receiver/slack_module/Dockerfile
    container_name: waddlebot-slack
    environment:
      MODULE_NAME: slack-collector
      MODULE_PORT: 8004
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # INTERACTION MODULES (Internal)
  # =============================================================================

  ai-interaction:
    build:
      context: .
      dockerfile: action/interactive/ai_interaction_module/Dockerfile
    container_name: waddlebot-ai
    environment:
      MODULE_NAME: ai-interaction
      MODULE_PORT: 8005
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      AI_PROVIDER: ${AI_PROVIDER:-waddleai}
      OLLAMA_HOST: ${OLLAMA_HOST:-localhost}
      OLLAMA_PORT: ${OLLAMA_PORT:-11434}
      OLLAMA_USE_TLS: ${OLLAMA_USE_TLS:-false}
      WADDLEAI_BASE_URL: ${WADDLEAI_BASE_URL:-http://waddleai:8000}
      WADDLEAI_API_KEY: ${WADDLEAI_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  alias-interaction:
    build:
      context: .
      dockerfile: action/interactive/alias_interaction_module/Dockerfile
    container_name: waddlebot-alias
    environment:
      MODULE_NAME: alias-interaction
      MODULE_PORT: 8010
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  shoutout-interaction:
    build:
      context: .
      dockerfile: action/interactive/shoutout_interaction_module/Dockerfile
    container_name: waddlebot-shoutout
    environment:
      MODULE_NAME: shoutout-interaction
      MODULE_PORT: 8011
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  inventory-interaction:
    build:
      context: .
      dockerfile: action/interactive/inventory_interaction_module/Dockerfile
    container_name: waddlebot-inventory
    environment:
      MODULE_NAME: inventory-interaction
      MODULE_PORT: 8024
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8024/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  calendar-interaction:
    build:
      context: .
      dockerfile: action/interactive/calendar_interaction_module/Dockerfile
    container_name: waddlebot-calendar
    environment:
      MODULE_NAME: calendar-interaction
      MODULE_PORT: 8030
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  memories-interaction:
    build:
      context: .
      dockerfile: action/interactive/memories_interaction_module/Dockerfile
    container_name: waddlebot-memories
    environment:
      MODULE_NAME: memories-interaction
      MODULE_PORT: 8031
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8031/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  youtube-music:
    build:
      context: .
      dockerfile: action/interactive/youtube_music_interaction_module/Dockerfile
    container_name: waddlebot-youtube-music
    environment:
      MODULE_NAME: youtube-music
      MODULE_PORT: 8025
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      BROWSER_SOURCE_API_URL: http://browser-source:8027
      YOUTUBE_API_KEY: ${YOUTUBE_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - browser-source
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8025/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  spotify-interaction:
    build:
      context: .
      dockerfile: action/interactive/spotify_interaction_module/Dockerfile
    container_name: waddlebot-spotify
    environment:
      MODULE_NAME: spotify-interaction
      MODULE_PORT: 8026
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      BROWSER_SOURCE_API_URL: http://browser-source:8027
      SPOTIFY_CLIENT_ID: ${SPOTIFY_CLIENT_ID}
      SPOTIFY_CLIENT_SECRET: ${SPOTIFY_CLIENT_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - browser-source
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8026/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # CORE SYSTEM MODULES (Internal)
  # =============================================================================

  labels-core:
    build:
      context: .
      dockerfile: core/labels_core_module/Dockerfile
    container_name: waddlebot-labels
    environment:
      MODULE_NAME: labels-core
      MODULE_PORT: 8023
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-waddlebot_redis}
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8023/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  browser-source:
    build:
      context: .
      dockerfile: core/browser_source_core_module/Dockerfile
    container_name: waddlebot-browser-source
    environment:
      MODULE_NAME: browser-source
      MODULE_PORT: 8027
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8027:8027"  # Browser sources need direct access from OBS
    networks:
      - waddlebot-public
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8027/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  identity-core:
    build:
      context: .
      dockerfile: core/identity_core_module/Dockerfile
    container_name: waddlebot-identity
    environment:
      MODULE_NAME: identity-core
      MODULE_PORT: 8050
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-waddlebot_redis}
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # SUPPORTING MODULES (Internal)
  # =============================================================================

  community:
    build:
      context: .
      dockerfile: core/community_module/Dockerfile
    container_name: waddlebot-community
    environment:
      MODULE_NAME: community
      MODULE_PORT: 8020
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8020/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  reputation:
    build:
      context: .
      dockerfile: core/reputation_module/Dockerfile
    container_name: waddlebot-reputation
    environment:
      MODULE_NAME: reputation
      MODULE_PORT: 8021
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8021/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # PUSHING ACTION MODULES (Platform Integration)
  # =============================================================================

  discord-action:
    build:
      context: .
      dockerfile: action/pushing/discord_action_module/Dockerfile
    container_name: waddlebot-discord-action
    environment:
      MODULE_NAME: discord-action
      GRPC_PORT: 50051
      REST_PORT: 8070
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}
      MODULE_SECRET_KEY: ${MODULE_SECRET_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  slack-action:
    build:
      context: .
      dockerfile: action/pushing/slack_action_module/Dockerfile
    container_name: waddlebot-slack-action
    environment:
      MODULE_NAME: slack-action
      GRPC_PORT: 50052
      REST_PORT: 8071
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      MODULE_SECRET_KEY: ${MODULE_SECRET_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8071/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  twitch-action:
    build:
      context: .
      dockerfile: action/pushing/twitch_action_module/Dockerfile
    container_name: waddlebot-twitch-action
    environment:
      MODULE_NAME: twitch-action
      GRPC_PORT: 50053
      REST_PORT: 8072
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
      MODULE_SECRET_KEY: ${MODULE_SECRET_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8072/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  youtube-action:
    build:
      context: .
      dockerfile: action/pushing/youtube_action_module/Dockerfile
    container_name: waddlebot-youtube-action
    environment:
      MODULE_NAME: youtube-action
      GRPC_PORT: 50054
      REST_PORT: 8073
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      YOUTUBE_API_KEY: ${YOUTUBE_API_KEY}
      YOUTUBE_CLIENT_ID: ${YOUTUBE_CLIENT_ID}
      YOUTUBE_CLIENT_SECRET: ${YOUTUBE_CLIENT_SECRET}
      MODULE_SECRET_KEY: ${MODULE_SECRET_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8073/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # SERVERLESS PLATFORM ACTION MODULES
  # =============================================================================

  lambda-action:
    build:
      context: .
      dockerfile: action/pushing/lambda_action_module/Dockerfile
    container_name: waddlebot-lambda-action
    environment:
      MODULE_NAME: lambda-action
      GRPC_PORT: 50060
      REST_PORT: 8080
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_LAMBDA_ROLE_ARN: ${AWS_LAMBDA_ROLE_ARN:-}
      MODULE_SECRET_KEY: ${MODULE_SECRET_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  gcp-functions-action:
    build:
      context: .
      dockerfile: action/pushing/gcp_functions_action_module/Dockerfile
    container_name: waddlebot-gcp-functions-action
    environment:
      MODULE_NAME: gcp-functions-action
      GRPC_PORT: 50061
      REST_PORT: 8081
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      GCP_PROJECT_ID: ${GCP_PROJECT_ID}
      GCP_REGION: ${GCP_REGION:-us-central1}
      GCP_SERVICE_ACCOUNT_KEY: ${GCP_SERVICE_ACCOUNT_KEY:-}
      GCP_SERVICE_ACCOUNT_EMAIL: ${GCP_SERVICE_ACCOUNT_EMAIL:-}
      MODULE_SECRET_KEY: ${MODULE_SECRET_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  openwhisk-action:
    build:
      context: .
      dockerfile: action/pushing/openwhisk_action_module/Dockerfile
    container_name: waddlebot-openwhisk-action
    environment:
      MODULE_NAME: openwhisk-action
      GRPC_PORT: 50062
      REST_PORT: 8082
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      OPENWHISK_API_HOST: ${OPENWHISK_API_HOST:-http://openwhisk:3233}
      OPENWHISK_AUTH_KEY: ${OPENWHISK_AUTH_KEY:-23bc46b1-71f6-4ed5-8c54-816aa4f8c502:123zO3xZCLrMN6v2BKK1dXYFpXlPkccOFqm12CdAsMgRU4VrNZ9lyGVCGuMDGIwP}
      OPENWHISK_NAMESPACE: ${OPENWHISK_NAMESPACE:-guest}
      OPENWHISK_INSECURE: ${OPENWHISK_INSECURE:-true}
      MODULE_SECRET_KEY: ${MODULE_SECRET_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - postgres
      - openwhisk
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
