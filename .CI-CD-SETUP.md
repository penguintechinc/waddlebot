# WaddleBot CI/CD Setup - Version-Based Container Tagging

## Overview

Automated container builds with semantic versioning triggered by `.version` file changes and module modifications.

## Tagging Strategy

| Branch Type | Trigger | Container Tags | Latest Tag |
|-------------|---------|----------------|------------|
| **Non-main branches** (develop, feature/*, bugfix/*) | Any push | `v{version}-alpha` | ❌ No |
| **Main branch** (regular commits) | Push to main | `v{version}-beta` | ❌ No |
| **Version releases** | `.version` file change on main | `v{version}` | ✅ Yes |

### Examples

- Feature branch push with version 0.2.0: `v0.2.0-alpha`
- Main branch push with version 0.2.0: `v0.2.0-beta`
- Version release 0.2.0 on main: `v0.2.0` AND `latest`

## Workflow Structure

### Reusable Template
- **`.github/workflows/build-container.yml`**
  - Shared workflow template for all modules
  - Determines version and suffix automatically
  - Builds multi-platform containers (amd64, arm64)
  - Publishes to GitHub Container Registry (ghcr.io)

### Individual Module Workflows (24 total)

Each module has its own workflow file that calls the reusable template:

#### Processing Modules (1)
- `build-router.yml` - Router module (port 8000)

#### Core Modules (10)
- `build-workflow-core.yml` - Workflow automation (port 8070)
- `build-identity-core.yml` - Identity management (port 8050)
- `build-labels-core.yml` - Label system (port 8051)
- `build-browser-source-core.yml` - OBS overlays (port 8052)
- `build-community.yml` - Community management (port 8053)
- `build-reputation.yml` - Reputation tracking (port 8054)
- `build-security-core.yml` - Security services (port 8055)
- `build-ai-researcher.yml` - AI research (port 8056)
- `build-analytics-core.yml` - Analytics (port 8057)
- `build-hub.yml` - Admin hub (port 8060)

#### Trigger/Receiver Modules (4)
- `build-twitch.yml` - Twitch integration (port 8010)
- `build-discord.yml` - Discord integration (port 8011)
- `build-slack.yml` - Slack integration (port 8012)
- `build-youtube-live.yml` - YouTube Live integration (port 8013)

#### Action/Interactive Modules (9)
- `build-ai-interaction.yml` - AI interactions (port 8005)
- `build-alias-interaction.yml` - Command aliases (port 8006)
- `build-shoutout-interaction.yml` - Shoutouts (port 8007)
- `build-inventory-interaction.yml` - Inventory system (port 8008)
- `build-calendar-interaction.yml` - Calendar (port 8009)
- `build-memories-interaction.yml` - Memories (port 8014)
- `build-youtube-music-interaction.yml` - YouTube Music (port 8015)
- `build-spotify-interaction.yml` - Spotify (port 8016)
- `build-loyalty-interaction.yml` - Loyalty points (port 8017)

## Triggers

Each module workflow triggers on:

1. **Push to branches:**
   - `main`
   - `develop`
   - `feature/**`
   - `bugfix/**`

2. **Path changes:**
   - Module's own directory
   - `libs/flask_core/**` (shared library)
   - `.version` file
   - Workflow files

3. **Pull requests** to `main` or `develop`

4. **Manual dispatch** via GitHub UI

## Version Release Process

### Automated Flow

1. **Developer updates `.version` file** on main branch
   ```bash
   echo "0.3.0" > .version
   git add .version
   git commit -m "Release v0.3.0"
   git push origin main
   ```

2. **Version-release workflow** (`version-release.yml`) runs:
   - Detects `.version` file change
   - Creates GitHub pre-release tagged `v0.3.0`
   - Includes release notes

3. **All 24 module workflows** trigger automatically:
   - Detect `.version` changed
   - Build containers with tags: `v0.3.0` AND `latest`
   - Push to `ghcr.io/{owner}/waddlebot/{module}:v0.3.0`
   - Push to `ghcr.io/{owner}/waddlebot/{module}:latest`

4. **Containers available** at:
   ```
   ghcr.io/{owner}/waddlebot/router:v0.3.0
   ghcr.io/{owner}/waddlebot/router:latest
   ghcr.io/{owner}/waddlebot/workflow-core:v0.3.0
   ghcr.io/{owner}/waddlebot/workflow-core:latest
   ... (all 24 modules)
   ```

### Manual Version Update

Use the version management script:

```bash
# Increment build number (0.2.0 -> 0.2.1)
./scripts/version/update-version.sh

# Increment patch (0.2.0 -> 0.2.1)
./scripts/version/update-version.sh patch

# Increment minor (0.2.0 -> 0.3.0)
./scripts/version/update-version.sh minor

# Increment major (0.2.0 -> 1.0.0)
./scripts/version/update-version.sh major
```

## Container Registry

All containers published to GitHub Container Registry (ghcr.io):

- **Registry:** `ghcr.io`
- **Namespace:** `{github-owner}/waddlebot`
- **Image naming:** `{module-name}`
- **Example:** `ghcr.io/yourorg/waddlebot/workflow-core:v0.2.0`

## Build Features

### Multi-Platform Support
- Linux AMD64 (x86_64)
- Linux ARM64 (aarch64)

### Build Optimization
- Docker Buildx for improved performance
- GitHub Actions cache per module
- Separate cache scopes prevent conflicts
- Incremental builds when possible

### Build Arguments
Each container receives:
- `MODULE_NAME` - Container name
- `MODULE_PORT` - Listening port

## Monitoring Builds

### GitHub Actions UI
1. Go to repository → Actions tab
2. View individual module workflows
3. Check build status, logs, artifacts

### Build Summary
Each workflow generates a summary showing:
- Image name and registry path
- Tags applied
- Version and suffix
- Build completion status

## Configuration Files

### Reusable Workflow Template
**File:** `.github/workflows/build-container.yml`
- Version determination logic
- Suffix calculation (alpha/beta/release)
- Docker build and push steps
- Multi-platform configuration

### Module Workflows
**Pattern:** `.github/workflows/build-{module}.yml`
- Calls reusable template with module-specific parameters
- Defines trigger paths
- Inherits secrets from repository

### Version Release Workflow
**File:** `.github/workflows/version-release.yml`
- Detects `.version` file changes
- Creates GitHub pre-releases
- Provides release notes

## Troubleshooting

### Build Fails
1. Check workflow logs in GitHub Actions
2. Verify Dockerfile exists in module path
3. Ensure `libs/flask_core` dependencies resolve
4. Check Docker build context

### Wrong Tags
1. Verify `.version` file contains correct version
2. Check if push is to correct branch
3. Ensure `.version` file change is detected (git diff)

### Missing Latest Tag
- `latest` tag only applied on version releases (when `.version` changes on main)
- Regular main branch pushes get `-beta` suffix
- Other branches get `-alpha` suffix

## Future Enhancements

- [ ] Integration tests after container builds
- [ ] Automatic staging deployments for beta tags
- [ ] Production deployments for release tags
- [ ] Vulnerability scanning with Trivy
- [ ] Container signing with cosign
- [ ] SBOM generation
- [ ] Release notes from conventional commits

---

**Last Updated:** 2025-12-09
**WaddleBot Version:** 0.2.0
**Total Module Workflows:** 24
**Workflow Files:** 27 (24 module + 1 reusable + 2 supporting)
