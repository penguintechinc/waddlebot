<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player Overlay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            overflow: hidden;
        }

        .music-overlay {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85), rgba(20, 20, 20, 0.85));
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            display: none;
        }

        .music-overlay.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .album-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(20px) brightness(0.4);
            border-radius: 15px;
            z-index: -1;
        }

        .content-wrapper {
            position: relative;
            z-index: 1;
        }

        .album-art {
            width: 100%;
            height: 200px;
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .track-info {
            color: white;
            text-align: left;
        }

        .track-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-artist {
            font-size: 16px;
            color: #ccc;
            margin-bottom: 5px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-album {
            font-size: 14px;
            color: #999;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1db954, #1ed760);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .platform-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            backdrop-filter: blur(10px);
        }

        .youtube-player {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }

        .youtube-player.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="music-overlay" id="musicOverlay">
        <div class="album-backdrop" id="albumBackdrop"></div>
        <div class="platform-badge" id="platformBadge">Spotify</div>
        <div class="content-wrapper">
            <!-- YouTube Player (hidden for Spotify) -->
            <div id="youtubePlayer" class="youtube-player"></div>

            <!-- Album Art (shown for Spotify, thumbnail for YouTube) -->
            <div class="album-art" id="albumArt"></div>

            <!-- Track Information -->
            <div class="track-info">
                <div class="track-title" id="trackTitle">No Track Playing</div>
                <div class="track-artist" id="trackArtist">Artist</div>
                <div class="track-album" id="trackAlbum">Album</div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let ytPlayer = null;
        let currentPlatform = 'spotify';

        // WebSocket connection to receive updates
        const ws = new WebSocket('ws://localhost:8052/ws/music');

        ws.onopen = () => {
            console.log('Connected to music overlay service');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            updateOverlay(data);
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        function updateOverlay(data) {
            const overlay = document.getElementById('musicOverlay');
            const albumArt = document.getElementById('albumArt');
            const albumBackdrop = document.getElementById('albumBackdrop');
            const trackTitle = document.getElementById('trackTitle');
            const trackArtist = document.getElementById('trackArtist');
            const trackAlbum = document.getElementById('trackAlbum');
            const progressFill = document.getElementById('progressFill');
            const platformBadge = document.getElementById('platformBadge');
            const youtubePlayerDiv = document.getElementById('youtubePlayer');

            if (!data || !data.is_playing) {
                overlay.classList.remove('active');
                return;
            }

            overlay.classList.add('active');
            currentPlatform = data.platform || 'spotify';

            // Update platform badge
            platformBadge.textContent = currentPlatform === 'youtube' ? 'YouTube Music' : 'Spotify';

            // Update track info
            trackTitle.textContent = data.track_name || 'Unknown Track';
            trackArtist.textContent = data.artist_name || 'Unknown Artist';
            trackAlbum.textContent = data.album_name || '';

            // Handle platform-specific display
            if (currentPlatform === 'youtube') {
                // YouTube: Show player and use video thumbnail as backdrop
                youtubePlayerDiv.classList.add('active');
                albumArt.style.display = 'none';

                const thumbnailUrl = data.thumbnail_url || data.album_art_url;
                albumBackdrop.style.backgroundImage = `url(${thumbnailUrl})`;

                // Initialize YouTube player if not exists
                if (!ytPlayer && data.video_id) {
                    ytPlayer = new YT.Player('youtubePlayer', {
                        videoId: data.video_id,
                        playerVars: {
                            autoplay: 1,
                            controls: 0,
                            modestbranding: 1
                        }
                    });
                } else if (ytPlayer && data.video_id) {
                    ytPlayer.loadVideoById(data.video_id);
                }
            } else {
                // Spotify: Show album art, hide player
                youtubePlayerDiv.classList.remove('active');
                albumArt.style.display = 'block';

                const artUrl = data.album_art_url || '';
                albumArt.style.backgroundImage = `url(${artUrl})`;
                albumBackdrop.style.backgroundImage = `url(${artUrl})`;
            }

            // Update progress
            const progress = (data.progress_ms / data.duration_ms) * 100;
            progressFill.style.width = `${progress}%`;
        }

        // Progress update timer
        setInterval(() => {
            const progressFill = document.getElementById('progressFill');
            const currentWidth = parseFloat(progressFill.style.width) || 0;
            if (currentWidth < 100) {
                progressFill.style.width = `${currentWidth + 0.1}%`;
            }
        }, 100);
    </script>
</body>
</html>
