version: '3.8'

# WaddleBot Flask/Quart Docker Compose
# Secure network isolation: internal services not exposed to host

networks:
  # Public network - services exposed to host
  waddlebot-public:
    driver: bridge

  # Internal network - database, redis, inter-service communication
  waddlebot-internal:
    driver: bridge
    internal: true

volumes:
  postgres-data:
  redis-data:

services:
  # =============================================================================
  # INFRASTRUCTURE SERVICES (Internal Only - NOT exposed to host)
  # =============================================================================

  postgres:
    image: postgres:15-alpine
    container_name: waddlebot-postgres
    environment:
      POSTGRES_USER: waddlebot
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-waddlebot_secret}
      POSTGRES_DB: waddlebot
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - waddlebot-internal
    # NO ports exposed - internal only
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U waddlebot"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: waddlebot-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-waddlebot_redis}
    volumes:
      - redis-data:/data
    networks:
      - waddlebot-internal
    # NO ports exposed - internal only
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-waddlebot_redis}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # =============================================================================
  # API GATEWAY (Public)
  # =============================================================================

  kong:
    image: kong:3.4-alpine
    container_name: waddlebot-kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_PROXY_LISTEN: 0.0.0.0:8000
    volumes:
      - ./kong/kong.yml:/kong/kong.yml:ro
    ports:
      - "8000:8000"   # Proxy (public API)
      - "8001:8001"   # Admin API
    networks:
      - waddlebot-public
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # CORE MODULES (Internal, accessed via Kong)
  # =============================================================================

  router:
    build:
      context: .
      dockerfile: router_module_flask/Dockerfile
    container_name: waddlebot-router
    environment:
      MODULE_NAME: router
      MODULE_PORT: 8000
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-waddlebot_redis}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  marketplace:
    build:
      context: .
      dockerfile: marketplace_module_flask/Dockerfile
    container_name: waddlebot-marketplace
    environment:
      MODULE_NAME: marketplace
      MODULE_PORT: 8001
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  portal:
    build:
      context: .
      dockerfile: portal_module_flask/Dockerfile
    container_name: waddlebot-portal
    environment:
      MODULE_NAME: portal
      MODULE_PORT: 8080
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      BROWSER_SOURCE_API_URL: http://browser-source:8027
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8080:8080"  # Portal WebUI exposed directly
    networks:
      - waddlebot-public
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # COLLECTOR MODULES (Internal)
  # =============================================================================

  twitch-collector:
    build:
      context: .
      dockerfile: twitch_module_flask/Dockerfile
    container_name: waddlebot-twitch
    environment:
      MODULE_NAME: twitch-collector
      MODULE_PORT: 8002
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
      TWITCH_WEBHOOK_SECRET: ${TWITCH_WEBHOOK_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  discord-collector:
    build:
      context: .
      dockerfile: discord_module_flask/Dockerfile
    container_name: waddlebot-discord
    environment:
      MODULE_NAME: discord-collector
      MODULE_PORT: 8003
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}
      DISCORD_APPLICATION_ID: ${DISCORD_APPLICATION_ID}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  slack-collector:
    build:
      context: .
      dockerfile: slack_module_flask/Dockerfile
    container_name: waddlebot-slack
    environment:
      MODULE_NAME: slack-collector
      MODULE_PORT: 8004
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # INTERACTION MODULES (Internal)
  # =============================================================================

  ai-interaction:
    build:
      context: .
      dockerfile: ai_interaction_module_flask/Dockerfile
    container_name: waddlebot-ai
    environment:
      MODULE_NAME: ai-interaction
      MODULE_PORT: 8005
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      AI_PROVIDER: ${AI_PROVIDER:-waddleai}
      OLLAMA_HOST: ${OLLAMA_HOST:-localhost}
      OLLAMA_PORT: ${OLLAMA_PORT:-11434}
      OLLAMA_USE_TLS: ${OLLAMA_USE_TLS:-false}
      WADDLEAI_BASE_URL: ${WADDLEAI_BASE_URL:-http://waddleai:8000}
      WADDLEAI_API_KEY: ${WADDLEAI_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  alias-interaction:
    build:
      context: .
      dockerfile: alias_interaction_module_flask/Dockerfile
    container_name: waddlebot-alias
    environment:
      MODULE_NAME: alias-interaction
      MODULE_PORT: 8010
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  shoutout-interaction:
    build:
      context: .
      dockerfile: shoutout_interaction_module_flask/Dockerfile
    container_name: waddlebot-shoutout
    environment:
      MODULE_NAME: shoutout-interaction
      MODULE_PORT: 8011
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  inventory-interaction:
    build:
      context: .
      dockerfile: inventory_interaction_module_flask/Dockerfile
    container_name: waddlebot-inventory
    environment:
      MODULE_NAME: inventory-interaction
      MODULE_PORT: 8024
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8024/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  calendar-interaction:
    build:
      context: .
      dockerfile: calendar_interaction_module_flask/Dockerfile
    container_name: waddlebot-calendar
    environment:
      MODULE_NAME: calendar-interaction
      MODULE_PORT: 8030
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  memories-interaction:
    build:
      context: .
      dockerfile: memories_interaction_module_flask/Dockerfile
    container_name: waddlebot-memories
    environment:
      MODULE_NAME: memories-interaction
      MODULE_PORT: 8031
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8031/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  youtube-music:
    build:
      context: .
      dockerfile: youtube_music_interaction_module_flask/Dockerfile
    container_name: waddlebot-youtube-music
    environment:
      MODULE_NAME: youtube-music
      MODULE_PORT: 8025
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      BROWSER_SOURCE_API_URL: http://browser-source:8027
      YOUTUBE_API_KEY: ${YOUTUBE_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - browser-source
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8025/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  spotify-interaction:
    build:
      context: .
      dockerfile: spotify_interaction_module_flask/Dockerfile
    container_name: waddlebot-spotify
    environment:
      MODULE_NAME: spotify-interaction
      MODULE_PORT: 8026
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      BROWSER_SOURCE_API_URL: http://browser-source:8027
      SPOTIFY_CLIENT_ID: ${SPOTIFY_CLIENT_ID}
      SPOTIFY_CLIENT_SECRET: ${SPOTIFY_CLIENT_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - browser-source
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8026/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # CORE SYSTEM MODULES (Internal)
  # =============================================================================

  labels-core:
    build:
      context: .
      dockerfile: labels_core_module_flask/Dockerfile
    container_name: waddlebot-labels
    environment:
      MODULE_NAME: labels-core
      MODULE_PORT: 8023
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-waddlebot_redis}
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8023/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  browser-source:
    build:
      context: .
      dockerfile: browser_source_core_module_flask/Dockerfile
    container_name: waddlebot-browser-source
    environment:
      MODULE_NAME: browser-source
      MODULE_PORT: 8027
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8027:8027"  # Browser sources need direct access from OBS
    networks:
      - waddlebot-public
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8027/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  identity-core:
    build:
      context: .
      dockerfile: identity_core_module_flask/Dockerfile
    container_name: waddlebot-identity
    environment:
      MODULE_NAME: identity-core
      MODULE_PORT: 8050
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-waddlebot_redis}
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # SUPPORTING MODULES (Internal)
  # =============================================================================

  community:
    build:
      context: .
      dockerfile: community_module_flask/Dockerfile
    container_name: waddlebot-community
    environment:
      MODULE_NAME: community
      MODULE_PORT: 8020
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8020/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  reputation:
    build:
      context: .
      dockerfile: reputation_module_flask/Dockerfile
    container_name: waddlebot-reputation
    environment:
      MODULE_NAME: reputation
      MODULE_PORT: 8021
      DATABASE_URL: postgresql://waddlebot:${POSTGRES_PASSWORD:-waddlebot_secret}@postgres:5432/waddlebot
      ROUTER_API_URL: http://router:8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - waddlebot-internal
    depends_on:
      - router
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8021/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
