# Kong Declarative Configuration for WaddleBot API Gateway
# All APIs exposed via api.waddlebot.io - No direct external access to services
# Excludes: Frontend, webhook receivers, OBS overlays (separate systems)

_format_version: "3.0"
_transform: true

# =============================================================================
# SERVICES - Backend API Modules
# =============================================================================

services:
  # Hub Module - Main API (user, community, admin, auth)
  - name: hub-service
    url: http://hub:8060
    connect_timeout: 10000
    read_timeout: 60000
    write_timeout: 60000
    retries: 3
    tags:
      - waddlebot
      - hub
      - core

  # Router Module - Internal Event Bus
  - name: router-service
    url: http://router:8000
    connect_timeout: 5000
    read_timeout: 30000
    retries: 2
    tags:
      - waddlebot
      - router
      - internal

  # Core Modules
  - name: identity-service
    url: http://identity-core:8050
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - core
      - identity

  - name: labels-service
    url: http://labels-core:8023
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - core
      - labels

  - name: reputation-service
    url: http://reputation-core:8021
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - core
      - reputation

  - name: community-service
    url: http://community-core:8020
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - core
      - community

  # Interactive Modules
  - name: ai-service
    url: http://ai-interaction:8005
    connect_timeout: 10000
    read_timeout: 120000
    tags:
      - waddlebot
      - interactive
      - ai

  - name: ai-researcher-service
    url: http://ai-researcher:8070
    connect_timeout: 10000
    read_timeout: 120000
    tags:
      - waddlebot
      - interactive
      - ai-researcher

  - name: alias-service
    url: http://alias:8010
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - alias

  - name: shoutout-service
    url: http://shoutout:8011
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - shoutout

  - name: inventory-service
    url: http://inventory:8024
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - inventory

  - name: calendar-service
    url: http://calendar:8030
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - calendar

  - name: memories-service
    url: http://memories:8031
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - memories

  - name: youtube-music-service
    url: http://youtube-music:8025
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - youtube-music

  - name: spotify-service
    url: http://spotify:8026
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - spotify

# =============================================================================
# ROUTES - API Path Mappings
# =============================================================================

routes:
  # --- Hub Module Routes (Main API) ---
  - name: hub-public
    service: hub-service
    paths:
      - /api/v1/public
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - public
      - no-auth

  - name: hub-auth
    service: hub-service
    paths:
      - /api/v1/auth
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - auth
      - no-auth

  - name: hub-user
    service: hub-service
    paths:
      - /api/v1/user
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - user
      - jwt-auth

  - name: hub-community
    service: hub-service
    paths:
      - /api/v1/community
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - community
      - jwt-auth

  - name: hub-admin
    service: hub-service
    paths:
      - /api/v1/admin
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - admin
      - jwt-auth

  - name: hub-marketplace
    service: hub-service
    paths:
      - /api/v1/marketplace
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - marketplace
      - jwt-auth

  - name: hub-platform
    service: hub-service
    paths:
      - /api/v1/platform
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - platform
      - jwt-auth

  - name: hub-superadmin
    service: hub-service
    paths:
      - /api/v1/superadmin
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - superadmin
      - jwt-auth

  - name: hub-internal
    service: hub-service
    paths:
      - /api/v1/internal
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - internal
      - api-key-auth

  # --- Router Module ---
  - name: router-api
    service: router-service
    paths:
      - /api/v1/router
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - router
      - api-key-auth

  # --- Core Module Routes ---
  - name: identity-api
    service: identity-service
    paths:
      - /api/v1/identity
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - identity
      - jwt-auth

  - name: labels-api
    service: labels-service
    paths:
      - /api/v1/labels
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - labels
      - jwt-auth

  - name: reputation-api
    service: reputation-service
    paths:
      - /api/v1/reputation
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - reputation
      - jwt-auth

  # --- Interactive Module Routes ---
  - name: ai-api
    service: ai-service
    paths:
      - /api/v1/ai
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - ai
      - jwt-auth

  - name: ai-researcher-api
    service: ai-researcher-service
    paths:
      - /api/v1/ai-researcher
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - ai-researcher
      - jwt-auth

  - name: alias-api
    service: alias-service
    paths:
      - /api/v1/alias
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - alias
      - api-key-auth

  - name: shoutout-api
    service: shoutout-service
    paths:
      - /api/v1/shoutout
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - shoutout
      - api-key-auth

  - name: inventory-api
    service: inventory-service
    paths:
      - /api/v1/inventory
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - inventory
      - jwt-auth

  - name: calendar-api
    service: calendar-service
    paths:
      - /api/v1/calendar
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - calendar
      - jwt-auth

  - name: memories-api
    service: memories-service
    paths:
      - /api/v1/memories
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - memories
      - jwt-auth

  - name: youtube-music-api
    service: youtube-music-service
    paths:
      - /api/v1/youtube-music
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - youtube-music
      - jwt-auth

  - name: spotify-api
    service: spotify-service
    paths:
      - /api/v1/spotify
    strip_path: false
    protocols:
      - http
      - https
    tags:
      - spotify
      - jwt-auth

# =============================================================================
# CONSUMERS - API Consumers for Auth & Rate Limiting
# =============================================================================

consumers:
  - username: anonymous
    custom_id: anonymous-consumer
    tags:
      - anonymous

  - username: authenticated-user
    custom_id: authenticated-user
    tags:
      - authenticated

  - username: service-account
    custom_id: service-account
    tags:
      - service
      - internal

# =============================================================================
# PLUGINS - Global Configuration
# =============================================================================

plugins:
  # --- Global CORS ---
  - name: cors
    config:
      origins:
        - "https://hub.waddlebot.io"
        - "https://waddlebot.io"
        - "https://api.waddlebot.io"
        - "http://localhost:3000"
        - "http://localhost:8060"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
        - HEAD
      headers:
        - Authorization
        - Content-Type
        - X-API-Key
        - X-Request-ID
        - X-Requested-With
        - Accept
        - Origin
      exposed_headers:
        - X-Request-ID
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
        - X-RateLimit-Reset
      credentials: true
      max_age: 3600
      preflight_continue: false
    tags:
      - global
      - cors

  # --- Global Request Size Limit ---
  - name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes
    tags:
      - global
      - security

  # --- Global Rate Limiting ---
  - name: rate-limiting
    config:
      minute: 60
      hour: 1000
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      error_code: 429
      error_message: "Rate limit exceeded. Please slow down."
    tags:
      - global
      - rate-limiting

  # --- Request ID for tracing ---
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true
    tags:
      - global
      - tracing

  # ==========================================================================
  # JWT AUTHENTICATION - Protected Routes
  # ==========================================================================

  # JWT for user routes
  - name: jwt
    route: hub-user
    config:
      claims_to_verify:
        - exp
      header_names:
        - Authorization
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: false

  # JWT for community routes
  - name: jwt
    route: hub-community
    config:
      claims_to_verify:
        - exp
      header_names:
        - Authorization
      run_on_preflight: false

  # JWT for admin routes
  - name: jwt
    route: hub-admin
    config:
      claims_to_verify:
        - exp
      header_names:
        - Authorization
      run_on_preflight: false

  # JWT for marketplace routes
  - name: jwt
    route: hub-marketplace
    config:
      claims_to_verify:
        - exp
      header_names:
        - Authorization
      run_on_preflight: false

  # JWT for platform admin routes
  - name: jwt
    route: hub-platform
    config:
      claims_to_verify:
        - exp
      header_names:
        - Authorization
      run_on_preflight: false

  # JWT for superadmin routes
  - name: jwt
    route: hub-superadmin
    config:
      claims_to_verify:
        - exp
      header_names:
        - Authorization
      run_on_preflight: false

  # JWT for core module routes
  - name: jwt
    route: identity-api
    config:
      claims_to_verify:
        - exp

  - name: jwt
    route: labels-api
    config:
      claims_to_verify:
        - exp

  - name: jwt
    route: reputation-api
    config:
      claims_to_verify:
        - exp

  # JWT for interactive module routes
  - name: jwt
    route: ai-api
    config:
      claims_to_verify:
        - exp

  - name: jwt
    route: ai-researcher-api
    config:
      claims_to_verify:
        - exp

  - name: jwt
    route: inventory-api
    config:
      claims_to_verify:
        - exp

  - name: jwt
    route: calendar-api
    config:
      claims_to_verify:
        - exp

  - name: jwt
    route: memories-api
    config:
      claims_to_verify:
        - exp

  - name: jwt
    route: youtube-music-api
    config:
      claims_to_verify:
        - exp

  - name: jwt
    route: spotify-api
    config:
      claims_to_verify:
        - exp

  # ==========================================================================
  # API KEY AUTHENTICATION - Service Routes
  # ==========================================================================

  # API Key for internal hub routes (service-to-service)
  - name: key-auth
    route: hub-internal
    config:
      key_names:
        - X-API-Key
        - apikey
      hide_credentials: true

  # API Key for router API (service-to-service)
  - name: key-auth
    route: router-api
    config:
      key_names:
        - X-API-Key
        - apikey
      hide_credentials: true

  # API Key for alias (internal module)
  - name: key-auth
    route: alias-api
    config:
      key_names:
        - X-API-Key
      hide_credentials: true

  # API Key for shoutout (internal module)
  - name: key-auth
    route: shoutout-api
    config:
      key_names:
        - X-API-Key
      hide_credentials: true
