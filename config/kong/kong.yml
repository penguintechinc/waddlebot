# Kong Declarative Configuration for WaddleBot API Gateway
# All APIs exposed via api.waddlebot.io - No direct external access to services
# Excludes: Frontend, webhook receivers, OBS overlays (separate systems)

_format_version: "3.0"

# =============================================================================
# SERVICES - Backend API Modules with Nested Routes
# =============================================================================

services:
  # Hub Module - Main API (user, community, admin, auth)
  - name: hub-service
    url: http://hub:8060
    connect_timeout: 10000
    read_timeout: 60000
    write_timeout: 60000
    retries: 3
    tags:
      - waddlebot
      - hub
      - core
    routes:
      - name: hub-public
        paths:
          - /api/v1/public
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - public
          - no-auth
      - name: hub-auth
        paths:
          - /api/v1/auth
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - auth
          - no-auth
      - name: hub-user
        paths:
          - /api/v1/user
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - user
          - jwt-auth
      - name: hub-community
        paths:
          - /api/v1/community
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - community
          - jwt-auth
      - name: hub-communities
        paths:
          - /api/v1/communities
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - communities
          - jwt-auth
      - name: hub-admin
        paths:
          - /api/v1/admin
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - admin
          - jwt-auth
      - name: hub-marketplace
        paths:
          - /api/v1/marketplace
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - marketplace
          - jwt-auth
      - name: hub-platform
        paths:
          - /api/v1/platform
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - platform
          - jwt-auth
      - name: hub-superadmin
        paths:
          - /api/v1/superadmin
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - superadmin
          - jwt-auth
      - name: hub-internal
        paths:
          - /api/v1/internal
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - internal
          - api-key-auth

  # Router Module - Internal Event Bus
  - name: router-service
    url: http://router:8000
    connect_timeout: 5000
    read_timeout: 30000
    retries: 2
    tags:
      - waddlebot
      - router
      - internal
    routes:
      - name: router-api
        paths:
          - /api/v1/router
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - router
          - api-key-auth

  # Core Modules
  - name: identity-service
    url: http://identity-core:8050
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - core
      - identity
    routes:
      - name: identity-api
        paths:
          - /api/v1/identity
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - identity
          - jwt-auth

  - name: labels-service
    url: http://labels-core:8023
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - core
      - labels
    routes:
      - name: labels-api
        paths:
          - /api/v1/labels
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - labels
          - jwt-auth

  - name: reputation-service
    url: http://reputation:8021
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - core
      - reputation
    routes:
      - name: reputation-api
        paths:
          - /api/v1/reputation
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - reputation
          - jwt-auth

  - name: community-service
    url: http://community:8020
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - core
      - community
    routes:
      - name: community-api
        paths:
          - /api/v1/community-core
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - community
          - jwt-auth

  # Interactive Modules
  - name: ai-service
    url: http://ai-interaction:8005
    connect_timeout: 10000
    read_timeout: 120000
    tags:
      - waddlebot
      - interactive
      - ai
    routes:
      - name: ai-api
        paths:
          - /api/v1/ai
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - ai
          - jwt-auth

  - name: ai-researcher-service
    url: http://ai-researcher:8070
    connect_timeout: 10000
    read_timeout: 120000
    tags:
      - waddlebot
      - interactive
      - ai-researcher
    routes:
      - name: ai-researcher-api
        paths:
          - /api/v1/ai-researcher
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - ai-researcher
          - jwt-auth

  - name: alias-service
    url: http://alias-interaction:8010
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - alias
    routes:
      - name: alias-api
        paths:
          - /api/v1/alias
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - alias
          - api-key-auth

  - name: shoutout-service
    url: http://shoutout-interaction:8011
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - shoutout
    routes:
      - name: shoutout-api
        paths:
          - /api/v1/shoutout
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - shoutout
          - api-key-auth

  - name: inventory-service
    url: http://inventory-interaction:8024
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - inventory
    routes:
      - name: inventory-api
        paths:
          - /api/v1/inventory
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - inventory
          - jwt-auth

  - name: calendar-service
    url: http://calendar-interaction:8030
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - calendar
    routes:
      - name: calendar-api
        paths:
          - /api/v1/calendar
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - calendar
          - jwt-auth

  - name: memories-service
    url: http://memories-interaction:8031
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - memories
    routes:
      - name: memories-api
        paths:
          - /api/v1/memories
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - memories
          - jwt-auth

  - name: loyalty-service
    url: http://loyalty-interaction:8032
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - loyalty
    routes:
      - name: loyalty-api
        paths:
          - /api/v1/loyalty
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - loyalty
          - jwt-auth

  - name: youtube-music-service
    url: http://youtube-music:8025
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - youtube-music
    routes:
      - name: youtube-music-api
        paths:
          - /api/v1/youtube-music
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - youtube-music
          - jwt-auth

  - name: spotify-service
    url: http://spotify-interaction:8026
    connect_timeout: 5000
    read_timeout: 30000
    tags:
      - waddlebot
      - interactive
      - spotify
    routes:
      - name: spotify-api
        paths:
          - /api/v1/spotify
        strip_path: false
        protocols:
          - http
          - https
        tags:
          - spotify
          - jwt-auth

# =============================================================================
# CONSUMERS - API Consumers for Auth & Rate Limiting
# =============================================================================

consumers:
  - username: anonymous
    custom_id: anonymous-consumer
    tags:
      - anonymous

  - username: authenticated-user
    custom_id: authenticated-user
    tags:
      - authenticated

  - username: service-account
    custom_id: service-account
    tags:
      - service
      - internal

# =============================================================================
# PLUGINS - Global Configuration
# =============================================================================

plugins:
  # --- Global CORS ---
  - name: cors
    config:
      origins:
        - "https://hub.waddlebot.io"
        - "https://waddlebot.io"
        - "https://api.waddlebot.io"
        - "http://localhost:3000"
        - "http://localhost:8060"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
        - HEAD
      headers:
        - Authorization
        - Content-Type
        - X-API-Key
        - X-Request-ID
        - X-Requested-With
        - Accept
        - Origin
      exposed_headers:
        - X-Request-ID
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
        - X-RateLimit-Reset
      credentials: true
      max_age: 3600
      preflight_continue: false
    tags:
      - global
      - cors

  # --- Global Request Size Limit ---
  - name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes
    tags:
      - global
      - security

  # --- Global Rate Limiting ---
  - name: rate-limiting
    config:
      minute: 60
      hour: 1000
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      error_code: 429
      error_message: "Rate limit exceeded. Please slow down."
    tags:
      - global
      - rate-limiting

  # --- Request ID for tracing ---
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true
    tags:
      - global
      - tracing
