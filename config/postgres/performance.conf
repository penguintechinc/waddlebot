# PostgreSQL Performance Configuration for WaddleBot
# Include this in postgresql.conf or use as Docker environment variables

# =============================================================================
# Query Timeout and Performance Limits
# =============================================================================

# Maximum execution time for any query (30 seconds)
# Prevents runaway queries from consuming resources
statement_timeout = '30s'

# Time to wait for a lock before timing out (10 seconds)
lock_timeout = '10s'

# Idle transaction timeout (5 minutes)
# Closes idle transactions to prevent lock contention
idle_in_transaction_session_timeout = '5min'

# =============================================================================
# Slow Query Logging
# =============================================================================

# Log queries slower than 1 second
log_min_duration_statement = 1000

# Log slow autovacuum operations
log_autovacuum_min_duration = 5000

# What to log
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off # We use log_min_duration_statement instead
log_lock_waits = on
log_statement = 'ddl' # Log DDL statements (CREATE, ALTER, DROP)
log_temp_files = 0 # Log all temp file usage

# =============================================================================
# Connection Pooling
# =============================================================================

# Maximum connections (adjust based on your workload)
# 32 services Ã— 10 pool_size = 320 connections needed, plus overhead
max_connections = 400

# Connection cleanup
tcp_keepalives_idle = 60
tcp_keepalives_interval = 10
tcp_keepalives_count = 3

# =============================================================================
# Memory Configuration
# =============================================================================

# Shared buffers (25% of RAM is a good starting point)
shared_buffers = '256MB'

# Effective cache size (50-75% of RAM)
effective_cache_size = '1GB'

# Work memory per operation (for sorting, hashing)
work_mem = '16MB'

# Maintenance work memory (for VACUUM, CREATE INDEX)
maintenance_work_mem = '128MB'

# =============================================================================
# Query Planner
# =============================================================================

# Random page cost (lower for SSD)
random_page_cost = 1.1

# Effective I/O concurrency
effective_io_concurrency = 200

# Default statistics target
default_statistics_target = 100

# =============================================================================
# Write-Ahead Log (WAL)
# =============================================================================

# WAL level for replication
wal_level = replica

# Maximum WAL size before checkpoint
max_wal_size = '1GB'
min_wal_size = '80MB'

# Checkpoint completion target
checkpoint_completion_target = 0.9

# =============================================================================
# Autovacuum Tuning
# =============================================================================

# Autovacuum is critical for performance
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = '30s'

# Aggressive autovacuum for high-write tables
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_scale_factor = 0.02

# =============================================================================
# Monitoring Extensions
# =============================================================================

# Enable pg_stat_statements for query performance tracking
# Uncomment if you have superuser privileges:
# shared_preload_libraries = 'pg_stat_statements'
# pg_stat_statements.max = 10000
# pg_stat_statements.track = all

# =============================================================================
# Notes
# =============================================================================
# To apply these settings:
# 1. Docker: Add to environment variables (e.g., POSTGRES_STATEMENT_TIMEOUT=30s)
# 2. postgresql.conf: Include this file with `include 'performance.conf'`
# 3. ALTER SYSTEM: Use `ALTER SYSTEM SET parameter = value` (requires reload)
#
# After changes, reload configuration:
# SELECT pg_reload_conf();
# or restart PostgreSQL
