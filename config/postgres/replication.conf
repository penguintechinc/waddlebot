# PostgreSQL Streaming Replication Configuration for WaddleBot
# Include this in postgresql.conf or use as Docker environment variables
# This configuration enables high-performance read replicas for scaling read operations

# =============================================================================
# Write-Ahead Log (WAL) Configuration for Replication
# =============================================================================

# WAL level must be "replica" or higher to enable replication
wal_level = replica

# Keep WAL segments on primary for replicas to read
wal_keep_segments = 128  # ~2GB of WAL files for replica lag tolerance

# Timeout for standby replicas to keep connection (in milliseconds)
wal_sender_timeout = 60000

# WAL compression to reduce network bandwidth
wal_compression = on

# =============================================================================
# Replication Slots (Logical Slot Configuration)
# =============================================================================

# Maximum number of replication slots
max_replication_slots = 10

# Prevent WAL removal if replication slots are behind
max_slot_wal_keep_size = 2147483647  # Unlimited (in bytes)

# =============================================================================
# Hot Standby Configuration (for Read-Only Replicas)
# =============================================================================

# Allow queries on standby replicas (read-only mode)
hot_standby = on

# Maximum number of concurrent queries allowed on standby
hot_standby_feedback = on  # Send feedback to primary about oldest xmin

# Timeout for standby to report feedback (in milliseconds)
hot_standby_feedback_interval = 30000

# =============================================================================
# Synchronous Replication (Optional - Comment out for Asynchronous)
# =============================================================================

# Uncomment for synchronous replication (ensures data safety at cost of performance)
# synchronous_standby_names = '*'
# synchronous_commit = remote_apply  # Options: off, local, remote_write, remote_apply

# For async replication (default, better performance):
synchronous_commit = on  # Ensures commit durability on primary before returning to client

# =============================================================================
# Replication Authentication
# =============================================================================

# Replication connections use pg_hba.conf entries with "replication" keyword
# Example in pg_hba.conf:
# host    replication     replication_user    0.0.0.0/0    md5

# =============================================================================
# Monitoring and Debugging
# =============================================================================

# Log all replication connections and disconnections
log_replication_commands = on

# Log streaming standby snapshots
# log_standby_snapshots = on

# =============================================================================
# Advanced Replication Tuning
# =============================================================================

# Maximum WAL size before forced checkpoint (balance performance vs storage)
max_wal_size = 2GB
min_wal_size = 80MB

# Checkpoint parameters for replication stability
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min

# Segment size (16MB is default, can increase for high-throughput systems)
# Note: Only set at initdb time, typically leave as default
# wal_segment_size = 16MB

# =============================================================================
# Recovery and Standby Configuration
# =============================================================================

# These settings apply to standby servers during recovery:
# Place recovery.conf or use recovery_target_timeline settings

# Maximum delay between primary and replica before disconnection (in ms)
wal_retrieve_retry_interval = 5000

# Standby server delays all write-ahead log operations by this amount
# Useful for point-in-time recovery windows (0 = no delay)
recovery_min_apply_delay = 0

# =============================================================================
# Performance Considerations
# =============================================================================

# Shared buffers should match primary configuration
shared_buffers = 256MB

# Effective cache size for query planning
effective_cache_size = 1GB

# Work memory per query operation
work_mem = 16MB

# =============================================================================
# Notes
# =============================================================================
#
# To apply these settings:
#
# 1. Docker: Include this file in postgresql.conf with:
#    include '/etc/postgresql/replication.conf'
#
# 2. Or set as environment variables:
#    POSTGRES_INIT_ARGS="-c wal_level=replica -c hot_standby=on"
#
# 3. For streaming replication, on the primary:
#    - Ensure pg_hba.conf allows replication connections
#    - Create replication user: CREATE USER replication REPLICATION PASSWORD 'password';
#
# 4. On the standby:
#    - Use pg_basebackup to create initial data copy
#    - Configure recovery_target_timeline = 'latest' in recovery.conf
#    - Set primary_conninfo to connect to primary
#
# 5. Monitor replication lag:
#    SELECT now() - pg_last_xact_replay_timestamp() AS replication_lag;
#    SELECT slot_name, restart_lsn, confirmed_flush_lsn FROM pg_replication_slots;
#
# 6. To promote a standby to primary:
#    SELECT pg_promote();
#    or
#    pg_ctl promote -D /var/lib/postgresql/data
#
